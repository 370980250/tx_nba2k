<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tx.dao.TeamDao">
	<resultMap type="team" id="teamMap">
		<id column="id" property="id"/>
		<result column="tcname" property="tcname"/>
		<result column="tename" property="tename"/>
		<result column="pic" property="pic"/>
		<result column="pickid" property="pickid"/>
		<result column="win" property="win"/>
		<result column="lose" property="lose"/>
		<result column="updateDate" property="updateDate"/>
		<association property="grade" column="gid" javaType="grade" select="com.tx.dao.GradeDao.queryGradeById"></association>
		<association property="user" column="userid" javaType="user" select="com.tx.dao.UserDao.queryUserById"></association>
	</resultMap>
	<select id="queryTeamById" parameterType="int" resultMap="teamMap">
		select * from tx_team where id = #{tid}
	</select>

	<select id="queryTeam" parameterType="team" resultMap="teamMap">
		select * from tx_team where pickid = #{pickid} and gid=#{grade.id}
	</select>
	
	<select id="queryTeamByGid" parameterType="int" resultMap="teamMap">
		select * from tx_team where gid = #{gid}
	</select>
	<insert id="addTeam" parameterType="team">
		insert into tx_team(tcname,tename,pic,gid) values(#{tcname},#{tename},#{pic},#{grade.id})
	</insert>
	
	<select id="queryTeamListByPick" parameterType="int" resultMap="teamMap">
		select * from tx_team where gid = #{gid}  order by tename asc
	</select>
	
	<update id="updateTeam" parameterType="team">
		update tx_team 
		<trim prefix="set" suffixOverrides=",">
			<if test="pickid!=0">
				pickid = #{pickid},
			</if>
			<if test="win>0">
				win = #{win},
			</if>
			<if test="lose>0">
				lose = #{lose},
			</if>
			<if test="updateDate!=null">
				updateDate = #{updateDate},
			</if>
		</trim>
		where tcname=#{tcname} and gid=#{grade.id}
	</update>
	
	<update id="truncateTeam" parameterType="int">
		update tx_team set pickid = null where gid = #{gid}
	</update>
	
	<select id="queryTeamByTradeId" parameterType="trade" resultMap="teamMap">
		select tt.* from tx_team tt, tx_tradeandteam ttat where tt.id = ttat.teamid and tradeid = #{id}
	</select>
	
	<select id="queryTeamRankByGid" parameterType="int" resultMap="teamMap">
		select * from tx_team where gid = #{gid} order by (win*2+lose) desc,(win/(win+lose)) desc
	</select>
	<select id ="queryTeamPlayoffRankByGid" parameterType="int" resultMap="teamMap">
		select n.* from  (select t.*,rownum rn  from  (select * from tx_team  where gid =#{gid} order by (win*2+lose) desc) t ) n where rn <![CDATA[<=]]> 16 order by (win/(win+lose)) desc,(win*2+lose) desc
	</select>
	
	<select id="queryTeamByUser" parameterType="tradeOn" resultMap="teamMap">
		select * from tx_team where gid = #{grade.id} and userid = #{user.id}
	</select>
	
	<update id="updateTeamUseridByTid" parameterType="draft">
		update tx_team
		<trim prefix="set" suffixOverrides=",">
			<if test="u!=null">
				userid = #{u.id},
			</if>
		</trim>
		where id = #{team.id}
	</update>
</mapper>