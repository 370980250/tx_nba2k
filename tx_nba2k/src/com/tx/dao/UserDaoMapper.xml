<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tx.dao.UserDao">
	<resultMap type="user" id="userMap">
		<id column="id" property="id"/>
		<result column="uname" property="uname"/>
		<result column="pwd" property="pwd"/>
		<result column="pname" property="pname"/>
		<association property="power" javaType="power" column="pid" select="com.tx.dao.PowerDao.queryPower" ></association>
	</resultMap>
	<select id="queryUser" parameterType="user" resultMap="userMap">
		select * from tx_user where uname=#{uname} and pwd = #{pwd}
	</select>
	
	<insert id="regUser" parameterType="user">
		insert into tx_user(uname,pwd,pname,pid) values(#{uname},#{pwd},#{pname},1)
	</insert>
	
	<select id="queryUserByUname" parameterType="string" resultMap="userMap">
		select * from tx_user where uname=#{uname}
	</select>
	
	<select id="queryUserById" parameterType="int" resultMap="userMap">
		select * from tx_user where id=#{userid}
	</select>
	
	<select id="queryUserByPname" parameterType="string" resultMap="userMap">
		select * from tx_user where pname=#{pname}
	</select>
	
	<select id="addTempUser" parameterType="map" statementType="CALLABLE">
		{CALL pro_tx_tempuser(#{tempId,mode=OUT,jdbcType=INTEGER})}
	</select>
	
	
	<select id="queryTempId" resultType="Integer">
		select id from tx_tempuser where id = (select max(id) from tx_tempuser)
	</select>
	<parameterMap type="map" id="addUserMap">
		<parameter property="uname" mode="IN" jdbcType="VARCHAR" />
		<parameter property="pwd" mode="IN"  jdbcType="VARCHAR"/>
		<parameter property="pname" mode="IN" jdbcType="VARCHAR"/>
		<parameter property="pid" mode="IN" jdbcType="INTEGER"/>
		<parameter property="user" mode="OUT" jdbcType="CURSOR" resultMap="userMap" />
	</parameterMap>
	
	<insert id="addUser" parameterMap="addUserMap" statementType="CALLABLE" >
		{call  pro_tx_addUser(
		?,?,?,?,?)}
	</insert>
	
	<update id="updateUser" parameterType="user">
		update tx_user
		<trim prefix="set" suffixOverrides=",">
			<if test="pname!=null and pname!=''">
				pname = #{pname},
			</if>
			<if test="pwd!=null and pwd!=''">
				pwd = #{pwd},
			</if>
			<if test="power!=null and power.id!=0">
				pid = #{power.id},
			</if>
		</trim>
		where id = #{id}
	</update>
	
	<select id="queryUserList" resultMap="userMap" parameterType="partion">
		select n.* from (select t.*,rownum rn from (select * from tx_user order by id desc) t) n where rn>=#{start} and rn<![CDATA[<=]]>#{end}
	</select>
	
	<select id="getRowsCount"  resultType="int">
		select count(1) from tx_user
	</select>
</mapper>