package com.tx.service;

import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Random;

import org.apache.tomcat.util.buf.UDecoder;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.tx.dao.DraftDao;
import com.tx.pojo.Draft;
import com.tx.pojo.Grade;
import com.tx.pojo.Pick;
import com.tx.pojo.Team;
import com.tx.pojo.User;
import com.tx.service.inter.IDraftService;
import com.tx.service.inter.IPickService;
import com.tx.service.inter.ITeamService;
@Service
public class DraftService implements IDraftService {
	@Autowired
	private ITeamService its;
	@Autowired
	private IPickService ips;
	@Autowired
	private DraftDao dd;
	@Autowired
	Draft draft;
	@Autowired
	Grade grade;
	@Autowired
	User manager;
	@Autowired
	Team team;
	@Override
	public List<Draft> queryDraftList(int gid) {
		return dd.queryDraftList(gid);
	}
	@Override
	public int addDraft(Draft draft){
		return dd.addDraft(draft);
		
	}
	@Override
	public Draft queryDraft(Draft draft){
		return dd.queryDraft(draft);
		
	}
	@Override
	public int updateDraft(Draft draft) {
		return dd.updateDraft(draft);
	}
	
	@Override
	public int queryDraftById(int id) {
		return dd.queryDraftById(id);
	}
	@Override
	public Map<String, Object> join(int gid,int yesDan, User u) {
		Map<String,Object> json = new HashMap<String, Object>();
		if(u!=null&&yesDan==1){
			Draft draft = new Draft();
			Grade grade = new Grade();
			draft.setU(u);
			grade.setId(gid);
			draft.setGrade(grade);
			Draft temp = queryDraft(draft);
			if(temp==null){
				draft.setJoinDate(new Date());
				draft.setState(0);
				int flag = addDraft(draft);
				if(flag>0){
					json.put("meg", true);
					return json;
				}
			}
		}
		json.put("meg", false);
		return json;
	}
	@Override
	public Map<String, Object> passJoin(int id,int gid, User u) {
		Map<String, Object> json = new HashMap<String, Object>();
		if(u.getPower().getId()>=3){
			Draft draft = new Draft();
			draft.setAdmin(u);
			manager.setId(id);
			draft.setU(manager);
			draft.setState(1);
			draft.setPassDate(new Date());
			grade.setId(gid);
			draft.setGrade(grade);
			int flag = updateDraft(draft);
			if(flag>0){
				json.put("meg",true);
				return json;
			}
		}
		json.put("meg", false);
		return json;
	}
	@Override
	public Map<String, Object> drawInTonight(int gid,User u) {
		Map<String, Object> json = new HashMap<String, Object>();
		json.put("meg", "请先登录");
		if(u!=null){
			draft.setU(u);
			grade.setId(gid);
			draft.setGrade(grade);
			draft = queryDraft(draft);
			json.put("meg", "请先报名");
			if(draft!=null){
				json.put("meg", "你已经抽过签");
				if(draft.getPickid()==0){
					json.put("meg","请等待审核");
					//state == 0 表示 未审核
					if(draft.getState()==1){
						int flag = updateDraft(draft);
						if(flag>0){
							List<Pick> ps =  ips.queryPickList(gid);
							Random random = new Random();
							int arrInx = random.nextInt(ps.size()-1);
							Pick pick = ps.get(arrInx);
							pick.setState(0);
							pick.setGrade(grade);
							ips.updatePick(pick);
							draft.setPickid(pick.getPick());
							System.out.println(team);
							team.setPickid(pick.getPick());
							team.setGrade(grade);
							team = its.queryTeam(team);
							draft.setTeam(team);
							draft.setDrawDate(new Date());
							updateDraft(draft);
							if(draft.getTeam()!=null){
								json.put("meg", "抽签成功,您获得了第"+pick.getPick()+"顺位"+draft.getTeam().getTcname()+"队");
							}else{
								json.put("meg", "抽签成功,您获得了第"+pick.getPick()+"顺位");
							}
						}
					}
				}
			}
		}
		return json;
	}
	@Override
	public Map<String, Object> updateTeamAndPick(String[] tname, int[] pick,
			int gid) {
		Map<String,Object> json = new HashMap<String, Object>();
		Team team = new Team();
		Grade grade = new Grade();
		grade.setId(gid);
		team.setGrade(grade);
		if(tname.length == pick.length){
			its.truncateTeam(gid);
			for(int i = 0 ;i<tname.length;i++){
				team.setTcname(tname[i]);
				team.setPickid(pick[i]);
				its.updateTeam(team);
				team = its.queryTeam(team);
				List<Draft> ds = queryDraftList(gid);
				for(Draft d : ds){
					if(d.getPickid()!=0&&d.getPickid()==pick[i]){
						team.setTcname(tname[i]);
						team.setPickid(pick[i]);
						System.out.println(team.getPickid());
						System.out.println(team.getTcname());
						team = its.queryTeam(team);
						d.setTeam(team);
						updateDraft(d);
					}
				}
			}
			
		}
		json.put("meg", "修改成功");
		return json;
	}
	@Override
	public int updateDraftById(Draft draft) {
		// TODO Auto-generated method stub
		return dd.updateDraftById(draft);
	}
	
	
	
	
	
}
